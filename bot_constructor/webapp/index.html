<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SynapserAI ‚Äî –º–∞—Å—Ç–µ—Ä –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{margin:0;background:#0f1115;color:#eaecef;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:640px;margin:0 auto;padding:20px}
    h1{font-size:22px;margin:12px 0 8px}
    .card{background:#151821;border:1px solid #202534;border-radius:16px;padding:16px;margin:12px 0}
    label{opacity:.9;font-size:14px}
    input,textarea,select,button{width:100%;margin-top:8px;padding:12px;border-radius:12px;border:1px solid #2a3142;background:#0f1320;color:#eaecef}
    textarea{min-height:120px;resize:vertical}
    button{border:0;background:#4b8cff;font-weight:600;cursor:pointer}
    .row{display:flex;gap:10px}
    .row>button{flex:1}
    .muted{opacity:.75;font-size:13px}
    .hidden{display:none}
    .ok{color:#7ee787}
    .err{color:#ff8182;white-space:pre-wrap}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{padding:8px 10px;border:1px solid #2a3142;border-radius:999px;cursor:pointer}
    .chip.active{background:#1f2940}
    .center{display:flex;justify-content:center;gap:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>–°–æ–∑–¥–∞–π –ò–ò‚Äë–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∑–∞ 2 –º–∏–Ω—É—Ç—ã</h1>
  <div id="msg" class="muted"></div>

  <!-- –®–∞–≥ 1 -->
  <div id="s1" class="card">
    <label>–û–ø–∏—à–∏—Ç–µ –±–∏–∑–Ω–µ—Å</label>
    <textarea id="business" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞—Ñ–µ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –∫–æ—Ñ–µ –ø–æ –ê–ª–º–∞—Ç—ã"></textarea>
    <label>–ß—Ç–æ –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –±–æ—Ç?</label>
    <textarea id="abilities" placeholder="–û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–∫–∞–∑—ã, —Å–æ–≤–µ—Ç–æ–≤–∞—Ç—å –º–µ–Ω—é"></textarea>
    <div class="row">
      <button id="s1next">–î–∞–ª–µ–µ</button>
    </div>
  </div>

  <!-- –®–∞–≥ 2 -->
  <div id="s2" class="card hidden">
    <label>–¢–æ–Ω –æ–±—â–µ–Ω–∏—è</label>
    <div class="chips" id="tones">
      <div class="chip active" data-v="–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π">–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π</div>
      <div class="chip" data-v="–¥–µ–ª–æ–≤–æ–π">–¥–µ–ª–æ–≤–æ–π</div>
      <div class="chip" data-v="—ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π">—ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π</div>
    </div>
    <div class="row">
      <button id="s2back">–ù–∞–∑–∞–¥</button>
      <button id="s2next">–î–∞–ª–µ–µ</button>
    </div>
  </div>

  <!-- –®–∞–≥ 3 -->
  <div id="s3" class="card hidden">
    <label>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã (PDF / DOCX / XLSX / JPG/PNG)</label>
    <input id="file" type="file" multiple />
    <div class="muted">–ú–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å ‚Äî –±–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–æ–º–ø—Ç—É.</div>
    <div class="row">
      <button id="s3skip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      <button id="s3upload">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
    <div id="s3status" class="muted"></div>
  </div>

  <!-- –®–∞–≥ 4 -->
  <div id="s4" class="card hidden">
    <label>–ê–≤—Ç–æ—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç</label>
    <textarea id="prompt" placeholder="–ë—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤"></textarea>
    <div class="row">
      <button id="s4back">–ù–∞–∑–∞–¥</button>
      <button id="s4next">–î–∞–ª–µ–µ</button>
    </div>
  </div>

  <!-- –®–∞–≥ 5 -->
  <div id="s5" class="card hidden">
    <label>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
    <details>
      <summary>WhatsApp (Meta)</summary>
      <input id="wa_token" placeholder="Meta Access Token"/>
      <input id="wa_phone" placeholder="Phone Number ID"/>
    </details>
    <details>
      <summary>Telegram</summary>
      <input id="tg_token" placeholder="Bot Token (–µ—Å–ª–∏ —Å–≤–æ–π)"/>
    </details>
    <details>
      <summary>Instagram Direct (Meta)</summary>
      <input id="ig_app" placeholder="App ID (–æ–ø—Ü.)"/>
    </details>
    <div class="row">
      <button id="s5skip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      <button id="s5next">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <!-- –®–∞–≥ 6 -->
  <div id="s6" class="card hidden">
    <h2 class="ok">–í–∞—à –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤</h2>
    <div class="center">
      <button id="openTest">–û—Ç–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç‚Äë—á–∞—Ç</button>
      <button id="openTg">–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram</button>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="getCode">–ö–æ–¥ –¥–ª—è —Å–∞–π—Ç–∞</button>
      <button id="openPanel">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</button>
    </div>
  </div>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  tg?.expand();
  const initData = tg?.initData || "";

  const S = path => fetch(path, {method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({initData})}).then(r=>r.json());
  const P = (path, payload) => fetch(path, {method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({...payload, initData})}).then(r=>r.json());
  const G = path => fetch(path + "?initData=" + encodeURIComponent(initData)).then(r=>r.json());

  const $ = id => document.getElementById(id);
  const show = id => { ["s1","s2","s3","s4","s5","s6"].forEach(x=>$(x).classList.add("hidden")); $(id).classList.remove("hidden"); };

  // init
  (async () => {
    try {
      const v = await S("/api/verify");
      $("msg").textContent = "–ì–æ—Ç–æ–≤–æ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ";
      const saved = await G("/api/load_all");
      if (saved.business) $("business").value = saved.business;
      if (saved.abilities) $("abilities").value = saved.abilities;
      if (saved.tone) document.querySelectorAll("#tones .chip").forEach(c=>{
        c.classList.toggle("active", c.dataset.v===saved.tone);
      });
      if (saved.prompt) $("prompt").value = saved.prompt;
    } catch(e) {
      $("msg").textContent = "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: " + (e.message || e);
    }
  })();

  // –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  $("s1next").onclick = async () => {
    await P("/api/save_basics", {business: $("business").value, abilities: $("abilities").value});
    show("s2");
  };

  document.querySelectorAll("#tones .chip").forEach(chip=>{
    chip.onclick = () => {
      document.querySelectorAll("#tones .chip").forEach(c=>c.classList.remove("active"));
      chip.classList.add("active");
    };
  });
  $("s2back").onclick = ()=>show("s1");
  $("s2next").onclick = async ()=>{
    const tone = document.querySelector("#tones .chip.active")?.dataset.v || "–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π";
    await P("/api/save_tone", {tone});
    // –∞–≤—Ç–æ‚Äë–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞
    const r = await P("/api/generate_prompt", {});
    $("prompt").value = r.prompt || "";
    show("s3");
  };

  $("s3skip").onclick = ()=>show("s4");
  $("s3upload").onclick = async ()=>{
    const files = $("file").files;
    if (!files.length) return show("s4");
    let ok=0, fail=0;
    for (const f of files){
      const fd = new FormData();
      fd.append("initData", initData);
      fd.append("file", f);
      const res = await fetch("/api/upload_file", {method:"POST", body:fd});
      res.ok ? ok++ : fail++;
    }
    $("s3status").textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${ok}, –æ—à–∏–±–æ–∫: ${fail}`;
    show("s4");
  };

  $("s4back").onclick = ()=>show("s3");
  $("s4next").onclick = async ()=>{
    // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∞–≤–∏–ª –ø—Ä–æ–º–ø—Ç –≤—Ä—É—á–Ω—É—é ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏–º
    await P("/api/generate_prompt", {}); // —Ç—É—Ç –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å /api/save_prompt, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å
    show("s5");
  };

  $("s5skip").onclick = ()=>show("s6");
  $("s5next").onclick = async ()=>{
    const integrations = {
      whatsapp: {token:$("wa_token").value, phone_id:$("wa_phone").value},
      telegram: {bot_token:$("tg_token").value},
      instagram: {app_id:$("ig_app").value}
    };
    await P("/api/save_integrations", {integrations});
    show("s6");
  };

  $("openTest").onclick = ()=> tg?.showAlert?.("–ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç‚Äë—á–∞—Ç üòä");
  $("openTg").onclick   = ()=> tg?.openTelegramLink?.("https://t.me/");
  $("getCode").onclick  = ()=> tg?.showAlert?.("<script src='https://.../widget.js'></script>");
  $("openPanel").onclick= ()=> tg?.close(); // –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ —á–∞—Ç
</script>
</body>
</html>